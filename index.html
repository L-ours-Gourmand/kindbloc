<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Planificateur visuel - Prototype v3.1</title>
<style>
:root{--sidebar-width:320px;--hour-width:80px;--bg:#f6f7fb;--accent:#3467eb;--muted:#6b7280}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,Helvetica,sans-serif;background:var(--bg);color:#0f172a}
.app{display:flex;min-height:100vh;box-sizing:border-box;}
.sidebar{width:var(--sidebar-width);min-height:100vh;background:linear-gradient(180deg,#fff,#fbfdff);border-right:1px solid #e6e9ef;padding:16px;box-sizing:border-box;overflow-y:auto;position:relative;}
.sidebar h2{margin:0 36px 8px 0;font-size:18px;display:flex;align-items:center;gap:8px;}
.gear{position:absolute;right:12px;top:12px;background:none;border:none;cursor:pointer;padding:6px;border-radius:6px}
.btn{display:inline-block;padding:8px 10px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-weight:600}
.search{margin-top:10px;display:flex;gap:8px;align-items:center;}
.search input{flex:1;padding:8px;border-radius:8px;border:1px solid #e0e4ee;background:#fff}
.task-list{margin-top:12px;display:flex;flex-direction:column;gap:8px}
.task-item{padding:10px;border-radius:8px;border:2px solid transparent;display:flex;align-items:center;justify-content:space-between;gap:8px;cursor:grab}
.task-meta{font-size:12px;color:var(--muted);margin-top:4px}
.small-btn{padding:6px 8px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #e6e9ef;background:linear-gradient(180deg,#fff,#fcfdff)}
.timeline-wrap{flex:1;display:flex;overflow:auto;position:relative;padding:12px;background:transparent}
.days-column{display:flex;flex-direction:column;gap:12px;width:100%}
.day{background:linear-gradient(180deg,#fff,#fbfdff);border-radius:10px;padding:8px;border:1px solid #eceef5;box-shadow:0 2px 6px rgba(30,40,80,0.03)}
.day-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.hours{position:relative;display:flex;border-top:1px solid #eee;border-bottom:1px solid #eee;overflow:hidden}
.hour{min-width:var(--hour-width);padding:8px 6px;text-align:center;border-right:1px dashed #f0f2f7;font-size:12px;color:var(--muted);background:linear-gradient(180deg,#fafbff,#fff)}
.timeline-body{position:relative;overflow:hidden}
.task-block{position:absolute;border-radius:10px;display:flex;flex-direction:column;justify-content:flex-start;padding:10px;color:#fff;font-weight:700;box-shadow:0 6px 16px rgba(50,60,90,0.08);cursor:move;overflow:visible}
.task-name{font-size:13px;line-height:1.1;text-align:left;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin:0 0 6px 0}
.time-badge{position:absolute;right:8px;top:8px;background:#fff;color:#111;padding:4px 8px;border-radius:8px;border:2px solid rgba(0,0,0,0.08);font-size:12px;font-weight:700;box-shadow:0 2px 6px rgba(8,10,30,0.06)}
.block-controls{position:absolute;right:8px;bottom:6px;display:flex;gap:6px;align-items:center}
.icon-btn{width:30px;height:30px;border-radius:6px;border:none;background:rgba(255,255,255,0.12);display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
.done-chip{display:flex;align-items:center;gap:6px;padding:4px;border-radius:8px;background:rgba(255,255,255,0.9);font-size:12px;color:#111;border:2px solid rgba(0,0,0,0.06)}
.muted-small{color:#8892b0;font-size:12px}
.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border-radius:12px;box-shadow:0 12px 40px rgba(10,20,50,0.25);padding:18px;z-index:999;width:520px;max-width:95%}
.overlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.35);z-index:990}
label{display:block;font-size:13px;margin-top:8px;color:#223}
input[type="text"], input[type="number"], select {width:100%;padding:8px;border-radius:8px;border:1px solid #e3e6f0;background:#fff;box-sizing:border-box}
.row{display:flex;gap:8px;align-items:center}
.chip{font-size:12px;padding:6px 8px;border-radius:6px;background:#f4f6fb;border:1px solid #e6e9ef}
.completed{opacity:0.45;text-decoration:line-through}
.svg-btn{width:18px;height:18px;display:inline-block;vertical-align:middle;fill:currentColor}
.collapse-btn{font-size:12px;padding:6px;border-radius:6px;background:#fff;border:1px solid #e6e9ef}
@media (max-width:900px){:root{--sidebar-width:260px;--hour-width:60px} .sidebar{width:100%;position:relative} .main{margin-top:16px} .app{flex-direction:column} .topbar{position:sticky;top:0;z-index:20} .modal{width:95%}}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <h2>Planning <button id="btnSettings" class="gear" title="Paramètres">⚙️</button></h2>
    <div class="row" style="gap:10px;margin-top:10px;">
      <button class="btn" id="btnNew">+ Nouvelle tâche</button>
      <div class="muted-small">Durée par défaut : <strong id="defaultDurStr">1h</strong></div>
    </div>
    <div class="search">
      <input id="search" placeholder="Rechercher nom, famille ou groupe..." />
      <button class="small-btn" id="resetSearch">X</button>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
      <div class="chip">Non planifiées: <span id="countTasks">0</span></div>
      <div class="chip">Planifiées: <span id="countPlanned">0</span></div>
    </div>
    <div class="task-list" id="taskList"></div>
    <div style="height:40px;"></div>
    <div style="margin-top:12px;">
      <div class="muted-small">Astuce mobile: appuie sur une tâche puis "Placer".</div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="views">
        <button class="small-btn" data-view="1" id="viewDay">Jour</button>
        <button class="small-btn" data-view="7" id="viewWeek">Semaine</button>
        <button class="small-btn" data-view="30" id="viewMonth">Mois</button>
      </div>
      <div class="task-controls">
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;"><input type="checkbox" id="showCurrentLine" checked/> Ligne heure actuelle</label>
      </div>
    </div>

    <div class="timeline-wrap" id="timelineWrap">
      <div style="min-width:100%;">
        <div style="display:flex;gap:12px;align-items:flex-start;">
          <div id="daysColumn" class="days-column" style="flex:1"></div>
        </div>
      </div>
    </div>

    <footer style="padding:8px 16px;text-align:center;color:#6b7280;font-size:13px">Prototype v3.1 — sauvegarde locale. Utilise Export/Import pour transférer entre appareils.</footer>
  </main>
</div>

<!-- modal task -->
<div id="modalTemplate" style="display:none">
  <div class="overlay"></div>
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Nouvelle tâche</h3>
    <label>Nom</label><input id="tName" type="text" />
    <div class="row" style="gap:8px;">
      <div style="flex:1"><label>Durée (heures)</label><input id="tDurationH" type="number" min="0" step="1" value="1"/></div>
      <div style="flex:1"><label>Durée (minutes)</label><input id="tDurationM" type="number" min="0" step="5" value="0"/></div>
    </div>
    <label>Famille</label><input id="tFamily" type="text" placeholder="ex: administratif" />
    <label>Groupe</label><input id="tGroup" type="text" placeholder="ex: projet X" />
    <div class="row" style="margin-top:8px;align-items:center;">
      <label style="flex:1"><input id="tUrgent" type="checkbox" /> Urgent</label>
      <label style="flex:1"><input id="tImportant" type="checkbox" /> Important</label>
    </div>
    <label>Couleur fond (optionnel)</label><input id="tColor" type="color" value="#3b82f6" />
    <label>Couleur bordure (optionnel)</label><input id="tBorderColor" type="color" value="#1f4ed8" />
    <div class="row" style="margin-top:8px;align-items:center;">
      <button class="small-btn" id="btnPlace">Placer</button>
      <div style="margin-left:auto" class="muted-small">Placement mobile disponible ici.</div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button class="small-btn" id="btnCancel">Annuler</button>
      <button class="small-btn" id="btnDuplicate">Dupliquer</button>
      <button class="btn" id="btnSave">Enregistrer</button>
    </div>
  </div>
</div>

<!-- settings modal -->
<div id="settingsTpl" style="display:none;">
  <div class="overlay"></div>
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Paramètres</h3>
    <label>Durée par défaut (minutes)</label>
    <input id="defaultDuration" type="number" min="5" step="5" value="60"/>
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px;">
      <div><strong>Palette familles</strong></div>
      <div><button class="small-btn" id="addFam">+ famille</button></div>
    </div>
    <div id="familiesList" style="margin-top:8px"></div>
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:12px;">
      <div><strong>Palette groupes</strong></div>
      <div><button class="small-btn" id="addGroup">+ groupe</button></div>
    </div>
    <div id="groupsList" style="margin-top:8px"></div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="small-btn" id="btnExport">Exporter JSON</button>
      <label class="small-btn" style="padding:6px 10px;cursor:pointer;"><input type="file" id="importFile" style="display:none"/>Importer</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button class="small-btn" id="btnCloseSettings">Fermer</button>
    </div>
  </div>
</div>

<script>
// Config
const HOUR_WIDTH = 80;
const SNAP_MINUTES = 15;
let DEFAULT_DURATION_MIN = 60;

// State
let tasks = [];
let viewDays = 1;
let familiesPalette = {};
let groupsPalette = {};

const daysColumn = document.getElementById('daysColumn');
const searchInput = document.getElementById('search');
const countTasksEl = document.getElementById('countTasks');
const countPlannedEl = document.getElementById('countPlanned');

function uid(){ return 't'+Math.random().toString(36).slice(2,9); }
function save(){ localStorage.setItem('planner_v3_1', JSON.stringify({tasks,familiesPalette,groupsPalette,DEFAULT_DURATION_MIN})); }
function load(){ const raw = JSON.parse(localStorage.getItem('planner_v3_1')||'null'); if(raw){ tasks=raw.tasks||[]; familiesPalette=raw.familiesPalette||{}; groupsPalette=raw.groupsPalette||{}; DEFAULT_DURATION_MIN=raw.DEFAULT_DURATION_MIN||60; document.getElementById('defaultDuration').value=DEFAULT_DURATION_MIN; document.getElementById('defaultDurStr').textContent = (DEFAULT_DURATION_MIN>=60? (DEFAULT_DURATION_MIN/60+'h') : DEFAULT_DURATION_MIN+'m'); } else { tasks=[]; familiesPalette={}; groupsPalette={}; } }

function minutesToWidth(min){ return (min/60)*HOUR_WIDTH; }
function snapToGrid(px){ const step = (SNAP_MINUTES/60)*HOUR_WIDTH; return Math.round(px/step)*step; }
function formatDuration(min){ const h=Math.floor(min/60); const m=min%60; return (h? h+'h ':'') + (m? m+'m':'') || '0m'; }

function buildDaysArray(n){ const arr=[]; const today=new Date(); today.setHours(0,0,0,0); const half=Math.floor(n/2); for(let i=-half;i<n-half;i++){ const d=new Date(today); d.setDate(today.getDate()+i); arr.push(d);} return arr; }

// Modal logic
let currentModalTask = null;
function openModal(task){ currentModalTask = task||null; const tpl=document.getElementById('modalTemplate'); const overlay = tpl.querySelector('.overlay').cloneNode(true); const modal = tpl.querySelector('.modal').cloneNode(true); document.body.appendChild(overlay); document.body.appendChild(modal);
  const tName = modal.querySelector('#tName'); const tDurationH = modal.querySelector('#tDurationH'); const tDurationM = modal.querySelector('#tDurationM'); const tFamily = modal.querySelector('#tFamily'); const tGroup = modal.querySelector('#tGroup'); const tUrgent = modal.querySelector('#tUrgent'); const tImportant = modal.querySelector('#tImportant'); const tColor = modal.querySelector('#tColor'); const tBorderColor = modal.querySelector('#tBorderColor');
  const btnCancel = modal.querySelector('#btnCancel'); const btnSave = modal.querySelector('#btnSave'); const btnDuplicate = modal.querySelector('#btnDuplicate'); const btnPlace = modal.querySelector('#btnPlace');
  if(task){ tName.value=task.name; tDurationH.value=Math.floor(task.duration/60); tDurationM.value=task.duration%60; tFamily.value=task.family||''; tGroup.value=task.group||''; tUrgent.checked=!!task.urgent; tImportant.checked=!!task.important; tColor.value=task.color||'#3b82f6'; tBorderColor.value=task.borderColor||'#1f4ed8'; } else { tName.value=''; tDurationH.value=Math.floor(DEFAULT_DURATION_MIN/60); tDurationM.value=DEFAULT_DURATION_MIN%60; tFamily.value=''; tGroup.value=''; tUrgent.checked=false; tImportant.checked=false; tColor.value='#3b82f6'; tBorderColor.value='#1f4ed8'; }
  btnCancel.onclick=()=>{ modal.remove(); overlay.remove(); currentModalTask=null; };
  btnSave.onclick=()=>{ const name=tName.value.trim()||'Tâche'; const raw=Math.max(5,parseInt(tDurationH.value||0)*60 + parseInt(tDurationM.value||0)); const step=5; const dur=Math.round(raw/step)*step; if(task){ task.name=name; task.duration=dur; task.family=tFamily.value.trim(); task.group=tGroup.value.trim(); task.urgent=tUrgent.checked; task.important=tImportant.checked; task.color = tColor.value || familiesPalette[tFamily.value.trim()] || groupsPalette[tGroup.value.trim()] || task.color; task.borderColor = tBorderColor.value || task.borderColor; } else { const fam=tFamily.value.trim(); const grp=tGroup.value.trim(); const famColor = familiesPalette[fam]; const grpColor = groupsPalette[grp]; const nt={ id:uid(), name, duration:dur, family:fam, group:grp, urgent:tUrgent.checked, important:tImportant.checked, color: tColor.value || famColor || grpColor || '#3b82f6', borderColor: tBorderColor.value || famColor || grpColor || '#1f4ed8', x:null, dayIndex:null, completed:false }; tasks.push(nt); } save(); renderAll(); modal.remove(); overlay.remove(); currentModalTask=null; };
  btnDuplicate.onclick=()=>{ if(task){ const copy=JSON.parse(JSON.stringify(task)); copy.id=uid(); copy.x=null; copy.dayIndex=null; copy.completed=false; tasks.push(copy); save(); renderAll(); } };
  btnPlace.onclick=()=>{ const dayOffset = parseInt(prompt("Jour (0 = aujourd'hui, 1 = demain, -1 = hier):","0")) || 0; const timeStr = prompt("Heure de début (HH:MM) ex: 13:30","09:00") || "09:00"; const parts=timeStr.split(':'); const hh=parseInt(parts[0]||0); const mm=parseInt(parts[1]||0); const today=new Date(); today.setHours(0,0,0,0); today.setDate(today.getDate()+dayOffset); const days=buildDaysArray(viewDays); let dayIndex = days.findIndex(d=> d.toDateString()===today.toDateString()); if(dayIndex<0){ alert("Jour hors vue actuelle. Change la vue."); return; } const x = snapToGrid((hh + mm/60) * HOUR_WIDTH); if(task){ task.x=x; task.dayIndex=dayIndex; save(); renderAll(); } else { const name=tName.value.trim()||'Tâche'; const raw=Math.max(5,parseInt(tDurationH.value||0)*60 + parseInt(tDurationM.value||0)); const step=5; const dur=Math.round(raw/step)*step; const nt={ id:uid(), name, duration:dur, family:tFamily.value.trim(), group:tGroup.value.trim(), urgent:tUrgent.checked, important:tImportant.checked, color: tColor.value, borderColor: tBorderColor.value, x:x, dayIndex:dayIndex, completed:false }; tasks.push(nt); save(); renderAll(); modal.remove(); overlay.remove(); currentModalTask=null; } };
}

// Settings modal
function openSettings(){ const tpl=document.getElementById('settingsTpl'); const overlay=tpl.querySelector('.overlay').cloneNode(true); const modal=tpl.querySelector('.modal').cloneNode(true); document.body.appendChild(overlay); document.body.appendChild(modal);
  const defaultDuration = modal.querySelector('#defaultDuration'); const famList = modal.querySelector('#familiesList'); const grpList = modal.querySelector('#groupsList'); const addFam = modal.querySelector('#addFam'); const addGroup = modal.querySelector('#addGroup'); const btnExport = modal.querySelector('#btnExport'); const importFile = modal.querySelector('#importFile'); const btnCloseSettings = modal.querySelector('#btnCloseSettings');
  function renderPalettes(){ famList.innerHTML=''; grpList.innerHTML=''; Object.keys(familiesPalette).forEach(k=>{ const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.innerHTML=`<div style='width:28px;height:28px;border-radius:6px;border:2px solid rgba(0,0,0,0.06);background:${familiesPalette[k]}'></div><div style='flex:1'>${k}</div><button class='small-btn' data-key='${k}'>Suppr</button>`; famList.appendChild(row); row.querySelector('button').onclick=()=>{ delete familiesPalette[k]; save(); renderPalettes(); renderAll(); }; row.querySelector('div').onclick=()=>{ const c=prompt('Hex couleur pour '+k, familiesPalette[k]||'#ffffff'); if(c){ familiesPalette[k]=c; save(); renderPalettes(); renderAll(); } }; }); Object.keys(groupsPalette).forEach(k=>{ const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center'; row.innerHTML=`<div style='width:28px;height:28px;border-radius:6px;border:2px solid rgba(0,0,0,0.06);background:${groupsPalette[k]}'></div><div style='flex:1'>${k}</div><button class='small-btn' data-key='${k}'>Suppr</button>`; grpList.appendChild(row); row.querySelector('button').onclick=()=>{ delete groupsPalette[k]; save(); renderPalettes(); renderAll(); }; row.querySelector('div').onclick=()=>{ const c=prompt('Hex couleur pour '+k, groupsPalette[k]||'#ffffff'); if(c){ groupsPalette[k]=c; save(); renderPalettes(); renderAll(); } }; }); }
  renderPalettes();
  addFam.onclick=()=>{ const name=prompt('Nom de la famille'); if(!name) return; familiesPalette[name]='#a3bffa'; save(); renderPalettes(); renderAll(); };
  addGroup.onclick=()=>{ const name=prompt('Nom du groupe'); if(!name) return; groupsPalette[name]='#ffd6a5'; save(); renderPalettes(); renderAll(); };
  btnExport.onclick=()=>{ const data=JSON.stringify({tasks,familiesPalette,groupsPalette,DEFAULT_DURATION_MIN},null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='planner_export_v3_1.json'; a.click(); URL.revokeObjectURL(url); };
  importFile.addEventListener('change', e=>{ if(e.target.files && e.target.files[0]){ const reader=new FileReader(); reader.onload=()=>{ try{ const obj=JSON.parse(reader.result); tasks = obj.tasks || tasks; familiesPalette = obj.familiesPalette || familiesPalette; groupsPalette = obj.groupsPalette || groupsPalette; DEFAULT_DURATION_MIN = obj.DEFAULT_DURATION_MIN || DEFAULT_DURATION_MIN; document.getElementById('defaultDuration').value = DEFAULT_DURATION_MIN; save(); renderAll(); alert('Import réussi'); } catch(e){ alert('Fichier invalide'); } }; reader.readAsText(e.target.files[0]); } });
  btnCloseSettings.onclick=()=>{ modal.remove(); overlay.remove(); };
  defaultDuration.addEventListener('change', e=>{ DEFAULT_DURATION_MIN = Math.max(5, parseInt(e.target.value||60)); document.getElementById('defaultDurStr').textContent = (DEFAULT_DURATION_MIN>=60? (DEFAULT_DURATION_MIN/60+'h') : DEFAULT_DURATION_MIN+'m'); save(); });
}

// Render task list (unplaced tasks)
function renderTaskList(){ const list=document.getElementById('taskList'); list.innerHTML=''; const q=searchInput.value.trim().toLowerCase(); const grouped={}; tasks.filter(t=> t.dayIndex===null).forEach(t=>{ if(q && !(t.name.toLowerCase().includes(q) || (t.family||'').toLowerCase().includes(q) || (t.group||'').toLowerCase().includes(q))) return; const fam=t.family || 'Non classé'; if(!grouped[fam]) grouped[fam]={}; const grp=t.group || 'Général'; if(!grouped[fam][grp]) grouped[fam][grp]=[]; grouped[fam][grp].push(t); }); Object.keys(grouped).forEach(fam=>{ const fh=document.createElement('div'); fh.style.fontWeight='700'; fh.style.marginTop='6px'; fh.textContent=fam; list.appendChild(fh); Object.keys(grouped[fam]).forEach(grp=>{ const gh=document.createElement('div'); gh.className='muted-small'; gh.style.marginLeft='6px'; gh.textContent=grp; list.appendChild(gh); grouped[fam][grp].forEach(t=>{ const el=document.createElement('div'); el.className='task-item'; el.draggable=true; const bg = t.urgent? '#e03434' : (t.color || '#3b82f6'); const br = t.important? '#c60000' : (t.borderColor || '#1f4ed8'); el.style.background = bg; el.style.borderColor = br; if(t.completed) el.classList.add('completed'); el.innerHTML = `<div style="display:flex;flex-direction:column;min-width:0;"><div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:170px">${t.name}</div><div class="task-meta">${formatDuration(t.duration)}</div></div><div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;"><div style="display:flex;gap:6px;"><button class="small-btn" data-action="edit" data-id="${t.id}">Éditer</button><button class="small-btn" data-action="del" data-id="${t.id}">Suppr</button></div><label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-action="toggleDone" data-id="${t.id}" ${t.completed?'checked':''}/></label></div>`; el.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', JSON.stringify({type:'fromList',id:t.id})); }); el.addEventListener('click', e=>{ if('ontouchstart' in window && window.innerWidth < 900){ openModal(t); } }); list.appendChild(el); }); }); countTasksEl.textContent = tasks.filter(t=>t.dayIndex===null).length; countPlannedEl.textContent = tasks.filter(t=>t.dayIndex!==null).length; }

// Allow dropping to sidebar to unplace task
const sidebar = document.getElementById('sidebar');
sidebar.addEventListener('dragover', e=> e.preventDefault());
sidebar.addEventListener('drop', e=>{ e.preventDefault(); const payload=e.dataTransfer.getData('text/plain'); if(!payload) return; try{ const obj=JSON.parse(payload); const t = tasks.find(x=>x.id===obj.id); if(t){ t.x=null; t.dayIndex=null; save(); renderAll(); } } catch(err){ console.log(err); } });

// Render timeline with grid lines and blocks
function renderTimeline(){ daysColumn.innerHTML=''; const days = buildDaysArray(viewDays); days.forEach((day,index)=>{ const dayWrap=document.createElement('div'); dayWrap.className='day'; const isToday = day.toDateString() === (new Date()).toDateString(); const head=document.createElement('div'); head.className='day-head'; const dateStr = day.toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short'}); const leftHead=document.createElement('div'); leftHead.innerHTML=`<strong>${dateStr}</strong><div class="muted-small">${isToday?'Aujourd’hui':''}</div>`; const rightHead=document.createElement('div'); const collapseBtn=document.createElement('button'); collapseBtn.className='collapse-btn'; collapseBtn.textContent='Replier'; rightHead.appendChild(collapseBtn); head.appendChild(leftHead); head.appendChild(rightHead); dayWrap.appendChild(head);
    // hours header
    const hours = document.createElement('div'); hours.className='hours';
    for(let h=0;h<24;h++){ const hd=document.createElement('div'); hd.className='hour'; hd.style.minWidth=HOUR_WIDTH+'px'; hd.textContent = h+'h'; hours.appendChild(hd); }
    dayWrap.appendChild(hours);
    // body
    const body=document.createElement('div'); body.className='timeline-body'; body.style.minHeight='140px'; body.dataset.dayIndex=index;
    body.addEventListener('dragover', e=>e.preventDefault());
    body.addEventListener('drop', e=>{ e.preventDefault(); const payload = e.dataTransfer.getData('text/plain'); if(!payload) return; try{ const obj = JSON.parse(payload); const rect = body.getBoundingClientRect(); let x = e.clientX - rect.left + body.scrollLeft; x = snapToGrid(x); const t = tasks.find(x=>x.id===obj.id); if(t){ t.x = x; t.dayIndex = index; save(); renderAll(); } } catch(err){ console.log(err); } });
    // grid markers 15/30/60
    const grid = document.createElement('div'); grid.style.position='absolute'; grid.style.left='0'; grid.style.top='0'; grid.style.right='0'; grid.style.bottom='0'; grid.style.pointerEvents='none'; const total = HOUR_WIDTH*24; grid.style.width = total+'px';
    for(let i=0;i<24*(60/SNAP_MINUTES);i++){ const g=document.createElement('div'); g.style.position='absolute'; g.style.left = (i*(SNAP_MINUTES/60)*HOUR_WIDTH)+'px'; g.style.top='0'; g.style.bottom='0'; g.style.width='1px'; if(i%4===0) g.style.background='rgba(0,0,0,0.06)'; else if(i%2===0) g.style.background='rgba(0,0,0,0.035)'; else g.style.background='rgba(0,0,0,0.02)'; grid.appendChild(g); }
    body.appendChild(grid);
    // tasks for this day
    const dayTasks = tasks.filter(t=>t.dayIndex===index);
    const placed = [];
    dayTasks.forEach(t=>{ const start = t.x; const end = t.x + minutesToWidth(t.duration); let col=0; while(true){ let conflict=false; for(const p of placed){ if(p.col===col){ const pstart = p.task.x; const pend = p.task.x + minutesToWidth(p.task.duration); if(!(end <= pstart || start >= pend)){ conflict=true; break; } } } if(!conflict) break; col++; } placed.push({task:t,col}); });
    const maxCol = placed.reduce((m,p)=>Math.max(m,p.col),0)+1; body.style.height = Math.max(140, maxCol*64)+'px';
    placed.forEach(p=>{ const t = p.task; const block=document.createElement('div'); block.className='task-block'; block.style.left = t.x+'px'; block.style.top = (p.col*64 + 6)+'px'; block.style.width = Math.max(40, minutesToWidth(t.duration))+'px'; block.style.background = t.urgent? '#e03434' : (t.color||'#3b82f6'); block.style.border = '3px solid ' + (t.important? '#c60000' : (t.borderColor||'#0f172a')); if(t.completed) block.classList.add('completed');
      const nameEl=document.createElement('div'); nameEl.className='task-name'; nameEl.textContent = t.name; block.appendChild(nameEl);
      const badge=document.createElement('div'); badge.className='time-badge'; badge.textContent = formatDuration(t.duration); badge.style.borderColor = t.important? '#c60000' : (t.borderColor||'rgba(0,0,0,0.12)'); block.appendChild(badge);
      const ctrl=document.createElement('div'); ctrl.className='block-controls';
      const editBtn=document.createElement('button'); editBtn.className='icon-btn'; editBtn.title='Éditer'; editBtn.innerHTML = '<svg class=\"svg-btn\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41L18.37 3.29a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z\"/></svg>'; editBtn.onclick=(ev)=>{ ev.stopPropagation(); openModal(t); };
      const delBtn=document.createElement('button'); delBtn.className='icon-btn'; delBtn.title='Supprimer'; delBtn.innerHTML = '<svg class=\"svg-btn\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M9 3v1H4v2h16V4h-5V3H9zm1 5v10h2V8H10zm4 0v10h2V8h-2zM7 8v10h2V8H7z\"/></svg>'; delBtn.onclick=(ev)=>{ ev.stopPropagation(); deleteTask(t.id); };
      const doneChk = document.createElement('input'); doneChk.type='checkbox'; doneChk.checked = !!t.completed; doneChk.onchange = ()=>{ t.completed = doneChk.checked; save(); renderAll(); };
      const doneDiv=document.createElement('div'); doneDiv.className='done-chip'; doneDiv.appendChild(doneChk);
      ctrl.appendChild(editBtn); ctrl.appendChild(delBtn); ctrl.appendChild(doneDiv);
      block.appendChild(ctrl);
      block.addEventListener('dblclick', ()=> openModal(t));
      block.draggable = true;
      block.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', JSON.stringify({type:'fromTimeline',id:t.id})); });
      body.appendChild(block);
    });
    if(document.getElementById('showCurrentLine').checked){ const todayIndex = days.findIndex(d=> d.toDateString() === (new Date()).toDateString()); if(todayIndex === index){ const now=new Date(); const leftPx = (now.getHours() + now.getMinutes()/60) * HOUR_WIDTH; const line=document.createElement('div'); line.style.position='absolute'; line.style.left=leftPx+'px'; line.style.top='0'; line.style.bottom='0'; line.style.width='2px'; line.style.background='red'; line.style.zIndex='5'; body.appendChild(line); } }
    let collapsed=false; collapseBtn.onclick=()=>{ collapsed=!collapsed; body.style.display=collapsed?'none':'block'; collapseBtn.textContent = collapsed? 'Déplier':'Replier'; };
    dayWrap.appendChild(body); daysColumn.appendChild(dayWrap);
  }); }

function deleteTask(id){ if(!confirm('Supprimer cette tâche ?')) return; tasks = tasks.filter(t=>t.id!==id); save(); renderAll(); }

// export/import helpers
function exportJSON(){ const data=JSON.stringify({tasks,familiesPalette,groupsPalette,DEFAULT_DURATION_MIN},null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='planner_export_v3_1.json'; a.click(); URL.revokeObjectURL(url); }
function importJSON(file){ const reader=new FileReader(); reader.onload=()=>{ try{ const obj=JSON.parse(reader.result); tasks = obj.tasks || tasks; familiesPalette = obj.familiesPalette || familiesPalette; groupsPalette = obj.groupsPalette || groupsPalette; DEFAULT_DURATION_MIN = obj.DEFAULT_DURATION_MIN || DEFAULT_DURATION_MIN; document.getElementById('defaultDuration').value = DEFAULT_DURATION_MIN; save(); renderAll(); alert('Import réussi'); } catch(e){ alert('Fichier invalide'); } }; reader.readAsText(file); }

// initial render and handlers
function renderAll(){ renderTaskList(); renderTimeline(); }
function setupHandlers(){ document.getElementById('btnNew').addEventListener('click', ()=> openModal(null)); document.getElementById('btnSettings').addEventListener('click', ()=> openSettings()); document.getElementById('resetSearch').addEventListener('click', ()=>{ searchInput.value=''; renderTaskList(); }); searchInput.addEventListener('input', ()=> renderTaskList()); document.getElementById('viewDay').addEventListener('click', ()=>{ viewDays=1; renderAll(); }); document.getElementById('viewWeek').addEventListener('click', ()=>{ viewDays=7; renderAll(); }); document.getElementById('viewMonth').addEventListener('click', ()=>{ viewDays=30; renderAll(); }); document.getElementById('taskList').addEventListener('click', e=>{ const btn = e.target.closest('button'); if(!btn) return; const action = btn.dataset.action; const id = btn.dataset.id; if(action==='edit'){ const t = tasks.find(x=>x.id===id); if(t) openModal(t); } if(action==='del'){ deleteTask(id); } }); document.getElementById('taskList').addEventListener('change', e=>{ const cb=e.target; if(cb && cb.dataset && cb.dataset.action==='toggleDone'){ const id=cb.dataset.id; const t=tasks.find(x=>x.id===id); if(t){ t.completed=cb.checked; save(); renderAll(); } } });
  document.getElementById('importFile')?.addEventListener('change', e=>{ if(e.target.files && e.target.files[0]) importJSON(e.target.files[0]); });
  setInterval(save,60000); setInterval(()=>{ renderTimeline(); },60000);
}

load(); setupHandlers(); renderAll();
</script>
</body>
</html>